<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8" />
    <title>upload file ...</title>
    <link href="css/index.css" rel="stylesheet" />
    <script src="js/vue.js"></script>
    <style>
        .pc {
            padding-top: 18%;
            text-align: center;
        }

        .mb {
            padding-top: 400pt;
            text-align: center;
        }

        .mb button {
            font-size: 50pt;
            width: 55%;
            height: 120pt;
        }

        .scrollbar{
            width: 300pt;
            height: 13pt;
            border: 1px solid black;
            margin: 0px auto;
            background-color:whitesmoke;
        }

        .scrollbar span {
            display: inline-block;
            float: left;
            height: 13pt;
            background-color: #db1c45;
            width: 0px;
        }

        .pc label{
            display:block;
            width:80pt;
            height: 30pt;
            line-height: 30pt;
        }
    </style>
    <script type="text/javascript">
		var params = (function () {
		    //该方法用于获取链接中的参数集
		    var href = location.href;
		    if (href.indexOf('?') == -1) {
		        return null;
		    }
		    href = href.slice(href.indexOf('?') + 1);
		    href = href.split("&");
		    var ans = {};
		    for (var i = 0; i < href.length; i++) {
		        var tmp = href[i].split("=");
		        ans[tmp[0]] = tmp[1];
		    }
		    return ans;
		})();
    </script>
</head>
<body>
    <main :style="style">
        <input @change="upload" id="fileinput" type="file" style="display:none;"/>
        <div v-if="ispc" class="pc">
            <button v-if="waiting"><label for="fileinput">上传文件</label></button>
            <div v-else class="scrollbar">
                <span :style="scrollStyle"></span>
            </div>
        </div>
        <div v-if="!ispc" class="mb">
            <button v-if="waiting"><label for="fileinput">上传文件</label></button>
            <div v-else class="scrollbar">
                <span :style="scrollStyle"></span>
            </div>
        </div>
    </main>
    <footer>

    </footer>
    <script type="text/javascript">
        var main = new Vue({
            el: "main",
            data: {
                style: 'height:' +
                    (document.documentElement.clientHeight || document.body.clientHeight) + 'px',
                ispc: (function () {
                    var userAgent = navigator.userAgent;
                    if (userAgent.includes("Windows")) {
                        return true;
                    } else if (userAgent.includes("iPhone")
                        || userAgent.includes("Android")) {
                        return false;
                    } else {
                        return true;
                    }
                })(),
                waiting: true,
                scrollStyle: "width:0px;"
            },
            methods: {
                upload: function () {
                    this.waiting = false;
                    this.scrollBarAutoCtrl(0);
                    var file = document.querySelector("#fileinput").files[0];
                    var filename = file.name;
					filename = encodeURIComponent(filename);
					var formdata = new FormData();
                    formdata.append("avatar", file);
                    var xhr = new XMLHttpRequest();
					xhr.upload.addEventListener("progress", (event) => {
						if(event.lengthComputable)
							this.scrollBarAutoCtrl(event.loaded * 100 / event.total);
					});
					xhr.onreadystatechange = () => {
						if(xhr.readyState == 4 && xhr.status == 200){
							if(params != null && "uuid" in params){
								alert("上传完成");
								location.href = "/";
							}else{
								var text = xhr.responseText;
								var qrcode = "/resFile.html?uuid=" + text;
								localStorage.setItem("qrcode", qrcode);
								localStorage.setItem("uuid", text);
								localStorage.setItem("attention", "扫码获取上传内容");
								localStorage.setItem("fetch", "false");
								location.href = "./qrcode.html";
							}
						}
					};
					var query = "/fileUpload";
					if(params != null && "uuid" in params)
						query += "?uuid=" + params['uuid'];
                    xhr.open("post", query);
					xhr.send(formdata);
                },
                scrollBarAutoCtrl: function (percent) {
                    main.scrollStyle = "width:" + percent + "%;";
                }
            }
        });
    </script>
</body>
</html>